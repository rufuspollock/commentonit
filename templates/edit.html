    {{>header}}

    <h1 class="entry-title">{{pageTitle}}</h1>
    <!-- form to create a post -->
    <form id="new-post" action="new.html" method="post" class="doc-edit">
      <dl>
        <dt>
          <label>Title</label>
        </dt>
        <dd>
          <input type="text" name="title" value="{{title}}" class="doc-title" />
        </dd>
        <dt>
          <label for="body">Body</label>
        </dt>
        <dd>
          <textarea name="body" class="doc-body">{{body}}</textarea></p>
        </dd>
        <dt>
        <label for="tags">Click tags to add them. (split by ',')</label>
        </dt>
        <dd>
        <input type="text" name="tags" value="{{tags}}">
        </dd>
      </dl>
      <input id="preview" type="button" value="Preview"/>
      <input type="submit" value="Save &rarr;"/> 
      <span id="saved" style="display:none;">Saved</span>
    </form>
    <a target="_new" href="http://warpedvisions.org/projects/markdown-cheat-sheet/">Markdown help</a>
    <div id="show-preview"></div>
    <div id="account"></div>

  {{>footer}}

  {{>scripts}}
  <script type="text/javascript" charset="utf-8">
    $.couch.app(function(app) {
      var path = app.require("vendor/couchapp/lib/path").init(app.req);
      var postForm;
      
      var postDoc = {{{doc}}};

      $('label[for=body]').append(' <em>with '+(postDoc.format||'html')+'</em>');
      $("form#new-post").submit(function(e) {
        e.preventDefault();
        // TODO: get account stuff working again
        // postDoc.author = $$("#account").userCtx.name;
        postDoc.body = $("textarea[name=body]").val();
        postDoc.title = $("input[name=title]").val();
        var dtags = [], tags = $("input[name=tags]").val().split(",");
        for(var i in tags) {
          dtags.push($.trim(tags[i]));
        }
        postDoc.tags = dtags;
        if (!postDoc.created_at) {
          postDoc.created_at = new Date();
        }
        app.db.saveDoc(postDoc, {
          success : function(resp) {
            $("#saved").text("Saved _rev: "+resp.rev).fadeIn(500).fadeOut(6000);
            $('h1.entry-title').html('Updated successfully. <a href="'+path.show('view',resp.id)+'">View document</a>.');
          }
        });
        return false;
      });

      if (postDoc._id) {
        $('#preview').before('<input type="button" id="delete" value="Delete Post"/> ');
        $("#delete").click(function() {
          app.db.deleteDoc(postDoc, {
            success : function(resp) {
              $("h1").text("Deleted "+resp.id);
              $('form#new-post input').attr('disabled', true);
            }
          });
          return false;
        });
      }

      $("#preview").click(function() {
        var markdown = app.require("vendor/couchapp/lib/markdown");
        var html = markdown.encode($("textarea[name=body]").val());
        $('#show-preview').html(html);
      });
    });
  </script>
</html>
